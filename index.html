<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Target Scorer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #0a0a0a; color: #fff; padding: 15px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; padding: 20px; background: linear-gradient(135deg, #ff6b00, #ffd700); border-radius: 10px; margin-bottom: 20px; }
        .header h1 { font-size: 28px; color: #000; font-weight: 900; text-transform: uppercase; letter-spacing: 3px; }
        .shooter-input { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .shooter-input label { display: block; margin-bottom: 8px; color: #888; font-size: 12px; text-transform: uppercase; }
        .shooter-input input { width: 100%; padding: 12px; background: #000; border: 2px solid #333; color: #fff; font-size: 16px; border-radius: 5px; }
        .shooter-input input:focus { outline: none; border-color: #ff6b00; }
        .button-group { display: grid; gap: 15px; margin-bottom: 20px; }
        .btn { padding: 18px; font-size: 18px; font-weight: 700; text-transform: uppercase; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
        .btn-primary { background: linear-gradient(135deg, #ff6b00, #ff8800); color: #000; }
        .btn-primary:active { transform: scale(0.98); background: #ff6b00; }
        .btn-secondary { background: #1a1a1a; color: #fff; border: 2px solid #333; }
        .btn-secondary:active { background: #333; }
        .btn-danger { background: #ff3344; color: #fff; }
        #cameraInput { display: none; }
        #imagePreview { width: 100%; border-radius: 8px; margin: 20px 0; display: none; border: 2px solid #333; }
        .status { background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0; border: 2px solid #333; }
        .status.processing { border-color: #ff6b00; }
        .spinner { border: 3px solid #333; border-top: 3px solid #ff6b00; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results { display: none; }
        .score-box { background: linear-gradient(135deg, #1a1a1a, #0a0a0a); border: 3px solid #ff6b00; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .score-number { font-size: 72px; font-weight: 900; color: #ffd700; margin: 10px 0; }
        .score-label { color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: #00ff88; }
        .stat-label { color: #888; font-size: 11px; margin-top: 5px; }
        .target-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
        .target-cell { background: #1a1a1a; border: 2px solid #333; padding: 10px 5px; text-align: center; border-radius: 5px; }
        .target-num { font-size: 10px; color: #666; margin-bottom: 3px; }
        .target-score { font-size: 24px; font-weight: 900; color: #ff6b00; }
        .target-x { color: #ffd700; font-size: 14px; margin-top: 2px; }
        .target-empty { opacity: 0.3; }
        #resultCanvas { width: 100%; border-radius: 8px; border: 2px solid #333; margin-bottom: 20px; background: #fff; }
        .history-section { display: none; margin-top: 30px; }
        .history-item { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #333; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .history-id { font-weight: 700; color: #ff6b00; }
        .history-score { font-size: 32px; font-weight: 900; color: #00ff88; }
        .history-date { color: #666; font-size: 11px; }
        .history-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-small { padding: 8px 15px; font-size: 12px; }
        .error { background: #ff3344; color: #fff; padding: 12px; border-radius: 8px; margin: 15px 0; display: none; text-align: center; font-weight: 600; }
        .section-title { color: #ff6b00; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .toggle-btn { background: #1a1a1a; color: #ff6b00; border: 2px solid #333; padding: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 20px; }
        .toggle-btn:active { background: #333; }
        .empty-state { text-align: center; padding: 40px 20px; color: #666; }
        @media (max-width: 500px) { .score-number { font-size: 56px; } .target-score { font-size: 18px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ TARGET SCORER</h1>
        </div>

        <div id="mainSection">
            <div class="shooter-input">
                <label>Shooter ID (Optional)</label>
                <input type="text" id="shooterID" placeholder="e.g., ALPHA01" maxlength="20">
            </div>

            <div class="button-group">
                <input type="file" id="cameraInput" accept="image/*">
                <button class="btn btn-primary" onclick="openCamera()">üì∏ TAKE PHOTO</button>
                <button class="btn btn-secondary" onclick="selectImage()">üìÅ SELECT IMAGE</button>
            </div>

            <div class="error" id="errorMessage"></div>
            <div class="status" id="statusBox" style="display: none;">
                <div class="spinner"></div>
                <p>Processing image...</p>
            </div>

            <img id="imagePreview" alt="Target Preview">

            <div class="results" id="results">
                <div class="score-box">
                    <div class="score-label">TOTAL SCORE</div>
                    <div class="score-number" id="totalScore">0</div>
                </div>

                <div class="stats">
                    <div class="stat-item"><div class="stat-value" id="shotsFired">0/25</div><div class="stat-label">SHOTS</div></div>
                    <div class="stat-item"><div class="stat-value" id="xRingHits">0</div><div class="stat-label">X-RINGS</div></div>
                    <div class="stat-item"><div class="stat-value" id="avgScore">0.0</div><div class="stat-label">AVERAGE</div></div>
                    <div class="stat-item"><div class="stat-value" id="targetsHit">0/25</div><div class="stat-label">TARGETS HIT</div></div>
                </div>

                <div class="section-title">Individual Scores</div>
                <div class="target-grid" id="targetGrid"></div>

                <canvas id="resultCanvas"></canvas>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveResults()">üíæ SAVE RESULTS</button>
                    <button class="btn btn-secondary" onclick="resetApp()">üîÑ NEW TARGET</button>
                </div>
            </div>
        </div>

        <button class="toggle-btn" onclick="toggleHistory()">üìä VIEW SAVED RESULTS (<span id="historyCount">0</span>)</button>

        <div class="history-section" id="historySection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="section-title" style="margin: 0; border: none; padding: 0;">SAVED RESULTS</div>
                <button class="btn btn-danger btn-small" onclick="clearAllHistory()">üóëÔ∏è CLEAR ALL</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        console.log('App loaded!');

        let currentImage = null;
        let processedResults = null;
        let settings = { darkness: 50, minSize: 15, maxSize: 150 };

        function openCamera() {
            console.log('Opening camera...');
            const input = document.getElementById('cameraInput');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        function selectImage() {
            console.log('Opening file picker...');
            const input = document.getElementById('cameraInput');
            input.removeAttribute('capture');
            input.click();
        }

        document.getElementById('cameraInput').addEventListener('change', function(e) {
            console.log('File selected');
            const file = e.target.files[0];
            if (!file) return;

            showError('');
            document.getElementById('results').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('File loaded');
                const img = document.getElementById('imagePreview');
                img.src = event.target.result;
                img.style.display = 'block';
                processImage(event.target.result);
            };
            reader.onerror = () => showError('Failed to load image');
            reader.readAsDataURL(file);
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = message ? 'block' : 'none';
            errorDiv.textContent = message;
            if (message) console.error('Error:', message);
        }

        function processImage(imageSrc) {
            console.log('Processing...');
            const statusBox = document.getElementById('statusBox');
            statusBox.style.display = 'block';
            
            const img = new Image();
            img.onload = function() {
                try {
                    currentImage = img;
                    const results = detectAndScore(img);
                    processedResults = results;
                    displayResults(results);
                    statusBox.style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    console.log('Done!', results);
                } catch (error) {
                    console.error('Error:', error);
                    statusBox.style.display = 'none';
                    showError('Error: ' + error.message);
                }
            };
            img.onerror = () => { statusBox.style.display = 'none'; showError('Failed to load image'); };
            img.src = imageSrc;
        }

        function detectAndScore(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const gridRegion = { x: canvas.width * 0.05, y: canvas.height * 0.05, width: canvas.width * 0.9, height: canvas.height * 0.9 };
            const cellWidth = gridRegion.width / 5;
            const cellHeight = gridRegion.height / 5;
            
            const targets = [];
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const targetNum = row * 5 + col + 1;
                    const x = gridRegion.x + col * cellWidth;
                    const y = gridRegion.y + row * cellHeight;
                    targets.push({
                        number: targetNum, x, y, width: cellWidth, height: cellHeight,
                        centerX: x + cellWidth / 2, centerY: y + cellHeight / 2,
                        holes: [], score: 0, xRing: false
                    });
                }
            }
            
            detectHolesInTargets(data, canvas.width, canvas.height, targets);
            scoreTargets(targets, cellWidth);
            
            let totalScore = 0, xRingCount = 0, shotsFired = 0, targetsHit = 0;
            targets.forEach(t => {
                totalScore += t.score;
                if (t.xRing) xRingCount++;
                if (t.holes.length > 0) { shotsFired += t.holes.length; targetsHit++; }
            });
            
            return { targets, totalScore, xRingCount, shotsFired, targetsHit, avgScore: shotsFired > 0 ? (totalScore / shotsFired).toFixed(1) : '0.0' };
        }

        function detectHolesInTargets(data, width, height, targets) {
            const visited = new Array(width * height).fill(false);
            targets.forEach(target => {
                const startX = Math.floor(target.x), startY = Math.floor(target.y);
                const endX = Math.floor(target.x + target.width), endY = Math.floor(target.y + target.height);
                
                for (let y = startY; y < endY; y += 3) {
                    for (let x = startX; x < endX; x += 3) {
                        if (x < 0 || x >= width || y < 0 || y >= height) continue;
                        const idx = y * width + x;
                        if (visited[idx]) continue;
                        const pixelIdx = idx * 4;
                        const brightness = (data[pixelIdx] + data[pixelIdx + 1] + data[pixelIdx + 2]) / 3;
                        
                        if (brightness < settings.darkness) {
                            const hole = floodFill(data, width, height, x, y, visited, settings.darkness);
                            if (hole.pixels.length >= settings.minSize && hole.pixels.length <= settings.maxSize) {
                                target.holes.push(hole);
                            }
                        }
                    }
                }
            });
        }

        function floodFill(data, width, height, startX, startY, visited, threshold) {
            const pixels = [];
            const queue = [{x: startX, y: startY}];
            let sumX = 0, sumY = 0;
            
            while (queue.length > 0 && pixels.length < 500) {
                const {x, y} = queue.shift();
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                const idx = y * width + x;
                if (visited[idx]) continue;
                const pixelIdx = idx * 4;
                const brightness = (data[pixelIdx] + data[pixelIdx + 1] + data[pixelIdx + 2]) / 3;
                if (brightness >= threshold) continue;
                
                visited[idx] = true;
                pixels.push({x, y});
                sumX += x;
                sumY += y;
                
                queue.push({x: x + 1, y: y});
                queue.push({x: x - 1, y: y});
                queue.push({x: x, y: y + 1});
                queue.push({x: x, y: y - 1});
            }
            
            return { pixels: pixels, centerX: sumX / pixels.length, centerY: sumY / pixels.length };
        }

        function scoreTargets(targets, cellWidth) {
            targets.forEach(target => {
                if (target.holes.length === 0) { target.score = 0; target.xRing = false; return; }
                const hole = target.holes[0];
                const dx = hole.centerX - target.centerX;
                const dy = hole.centerY - target.centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const targetRadius = cellWidth / 2.5;
                const distancePercent = (distance / targetRadius) * 100;
                
                if (distancePercent < 10) { target.score = 10; target.xRing = true; }
                else if (distancePercent < 20) target.score = 10;
                else if (distancePercent < 30) target.score = 9;
                else if (distancePercent < 40) target.score = 8;
                else if (distancePercent < 50) target.score = 7;
                else if (distancePercent < 60) target.score = 6;
                else if (distancePercent < 70) target.score = 5;
                else if (distancePercent < 80) target.score = 4;
                else if (distancePercent < 90) target.score = 3;
                else if (distancePercent < 100) target.score = 2;
                else target.score = 1;
            });
        }

        function displayResults(results) {
            document.getElementById('totalScore').textContent = results.totalScore;
            document.getElementById('shotsFired').textContent = results.shotsFired + '/25';
            document.getElementById('xRingHits').textContent = results.xRingCount;
            document.getElementById('avgScore').textContent = results.avgScore;
            document.getElementById('targetsHit').textContent = results.targetsHit + '/25';
            
            const grid = document.getElementById('targetGrid');
            grid.innerHTML = '';
            results.targets.forEach(target => {
                const cell = document.createElement('div');
                cell.className = 'target-cell' + (target.holes.length === 0 ? ' target-empty' : '');
                cell.innerHTML = '<div class="target-num">T' + target.number + '</div><div class="target-score">' + target.score + '</div>' + (target.xRing ? '<div class="target-x">X</div>' : '');
                grid.appendChild(cell);
            });
            
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = currentImage.width;
            canvas.height = currentImage.height;
            ctx.drawImage(currentImage, 0, 0);
            
            results.targets.forEach(target => {
                ctx.strokeStyle = 'rgba(255, 107, 0, 0.3)';
                ctx.lineWidth = 2;
                ctx.strokeRect(target.x, target.y, target.width, target.height);
                target.holes.forEach(hole => {
                    ctx.beginPath();
                    ctx.arc(hole.centerX, hole.centerY, 12, 0, 2 * Math.PI);
                    ctx.strokeStyle = target.xRing ? '#ffd700' : '#00ff88';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(hole.centerX - 8, hole.centerY);
                    ctx.lineTo(hole.centerX + 8, hole.centerY);
                    ctx.moveTo(hole.centerX, hole.centerY - 8);
                    ctx.lineTo(hole.centerX, hole.centerY + 8);
                    ctx.stroke();
                });
            });
        }

        function saveResults() {
            if (!processedResults) { showError('No results to save'); return; }
            const shooterID = document.getElementById('shooterID').value.trim() || 'UNKNOWN';
            const record = {
                id: Date.now(), shooterID: shooterID, date: new Date().toISOString(),
                results: processedResults, imageData: document.getElementById('imagePreview').src
            };
            let records = JSON.parse(localStorage.getItem('targetScores') || '[]');
            records.push(record);
            localStorage.setItem('targetScores', JSON.stringify(records));
            updateHistoryCount();
            alert('‚úì Results saved!');
        }

        function resetApp() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('cameraInput').value = '';
            processedResults = null;
            showError('');
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            section.style.display = section.style.display === 'none' || !section.style.display ? 'block' : 'none';
            if (section.style.display === 'block') loadHistory();
        }

        function loadHistory() {
            const records = JSON.parse(localStorage.getItem('targetScores') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (records.length === 0) {
                historyList.innerHTML = '<div class="empty-state">No saved results yet</div>';
                return;
            }
            
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            historyList.innerHTML = records.map(r => {
                const date = new Date(r.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                return '<div class="history-item"><div class="history-header"><div><div class="history-id">' + r.shooterID + '</div><div class="history-date">' + dateStr + '</div></div><div class="history-score">' + r.results.totalScore + '</div></div><div style="font-size: 12px; color: #888;">Shots: ' + r.results.shotsFired + '/25 | X: ' + r.results.xRingCount + ' | Avg: ' + r.results.avgScore + '</div><div class="history-actions"><button class="btn btn-secondary btn-small" onclick="viewRecord(' + r.id + ')">üëÅÔ∏è VIEW</button><button class="btn btn-danger btn-small" onclick="deleteRecord(' + r.id + ')">üóëÔ∏è DELETE</button></div></div>';
            }).join('');
        }

        function viewRecord(id) {
            const records = JSON.parse(localStorage.getItem('targetScores') || '[]');
            const record = records.find(r => r.id === id);
            if (!record) return;
            document.getElementById('shooterID').value = record.shooterID;
            document.getElementById('imagePreview').src = record.imageData;
            document.getElementById('imagePreview').style.display = 'block';
            processedResults = record.results;
            currentImage = new Image();
            currentImage.src = record.imageData;
            displayResults(record.results);
            document.getElementById('results').style.display = 'block';
            toggleHistory();
            window.scrollTo(0, 0);
        }

        function deleteRecord(id) {
            if (!confirm('Delete this result?')) return;
            let records = JSON.parse(localStorage.getItem('targetScores') || '[]');
            records = records.filter(r => r.id !== id);
            localStorage.setItem('targetScores', JSON.stringify(records));
            loadHistory();
            updateHistoryCount();
        }

        function clearAllHistory() {
            if (!confirm('Delete ALL results?')) return;
            localStorage.removeItem('targetScores');
            loadHistory();
            updateHistoryCount();
        }

        function updateHistoryCount() {
            const records = JSON.parse(localStorage.getItem('targetScores') || '[]');
            document.getElementById('historyCount').textContent = records.length;
        }

        updateHistoryCount();
        console.log('Ready!');
    </script>
</body>
</html>
